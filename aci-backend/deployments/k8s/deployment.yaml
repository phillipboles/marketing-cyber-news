apiVersion: apps/v1
kind: Deployment
metadata:
  name: aci-backend
  namespace: aci-backend
  labels:
    app.kubernetes.io/name: aci-backend
    app.kubernetes.io/component: api
    app.kubernetes.io/part-of: aci-platform
    app.kubernetes.io/version: "1.0.0"
spec:
  # Number of pod replicas
  # Set to 2 for high availability in local development
  replicas: 2

  # Rolling update strategy for zero-downtime deployments
  strategy:
    type: RollingUpdate
    rollingUpdate:
      # Maximum number of pods that can be unavailable during update
      maxUnavailable: 1
      # Maximum number of extra pods that can be created during update
      maxSurge: 1

  selector:
    matchLabels:
      app.kubernetes.io/name: aci-backend
      app.kubernetes.io/component: api

  template:
    metadata:
      labels:
        app.kubernetes.io/name: aci-backend
        app.kubernetes.io/component: api
        app.kubernetes.io/part-of: aci-platform
        app.kubernetes.io/version: "1.0.0"
      annotations:
        # Force pod restart when ConfigMap or Secret changes
        checksum/config: "{{ include (print $.Template.BasePath \"/configmap.yaml\") . | sha256sum }}"
        checksum/secret: "{{ include (print $.Template.BasePath \"/secret.yaml\") . | sha256sum }}"

    spec:
      # Security: Run pods with a non-root user
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        # Prevent privilege escalation
        seccompProfile:
          type: RuntimeDefault

      # Graceful shutdown handling
      # Kubernetes will wait this long before forcefully terminating the pod
      terminationGracePeriodSeconds: 30

      # Use local images without pulling from registry (for minikube/kind)
      # Change to Always for production with remote registry
      imagePullSecrets: []

      containers:
      - name: aci-backend
        image: aci-backend:latest
        # For local development: IfNotPresent uses local images
        # For production: Always ensures latest image is pulled
        imagePullPolicy: IfNotPresent

        ports:
        - name: http
          containerPort: 8080
          protocol: TCP

        # Environment variables from ConfigMap
        envFrom:
        - configMapRef:
            name: aci-backend-config

        # Sensitive environment variables from Secret
        env:
        - name: DATABASE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: aci-backend-secrets
              key: DATABASE_PASSWORD
        - name: JWT_PRIVATE_KEY
          valueFrom:
            secretKeyRef:
              name: aci-backend-secrets
              key: JWT_PRIVATE_KEY
        - name: JWT_PUBLIC_KEY
          valueFrom:
            secretKeyRef:
              name: aci-backend-secrets
              key: JWT_PUBLIC_KEY
        - name: N8N_WEBHOOK_SECRET
          valueFrom:
            secretKeyRef:
              name: aci-backend-secrets
              key: N8N_WEBHOOK_SECRET
        - name: ANTHROPIC_API_KEY
          valueFrom:
            secretKeyRef:
              name: aci-backend-secrets
              key: ANTHROPIC_API_KEY

        # Readiness probe: Determines if pod is ready to receive traffic
        # Pod will be removed from service endpoints if this fails
        readinessProbe:
          httpGet:
            path: /v1/ready
            port: http
            scheme: HTTP
          # Wait 10 seconds after container starts before first probe
          initialDelaySeconds: 10
          # Check every 10 seconds
          periodSeconds: 10
          # Must succeed once to be marked ready
          successThreshold: 1
          # Mark as not ready after 3 consecutive failures
          failureThreshold: 3
          # Probe timeout
          timeoutSeconds: 5

        # Liveness probe: Determines if pod should be restarted
        # Kubernetes will restart the pod if this fails
        livenessProbe:
          httpGet:
            path: /v1/health
            port: http
            scheme: HTTP
          # Wait 30 seconds for application to fully start
          initialDelaySeconds: 30
          # Check every 15 seconds
          periodSeconds: 15
          # Mark as unhealthy after 3 consecutive failures
          failureThreshold: 3
          # Must succeed once to be marked healthy again
          successThreshold: 1
          # Probe timeout
          timeoutSeconds: 5

        # Resource limits and requests
        # Requests: Guaranteed resources for scheduling
        # Limits: Maximum resources the container can use
        resources:
          requests:
            # 250 milliCPU (0.25 cores)
            cpu: 250m
            # 128 MiB of memory
            memory: 128Mi
          limits:
            # 500 milliCPU (0.5 cores)
            cpu: 500m
            # 256 MiB of memory
            memory: 256Mi

        # Container-level security context
        securityContext:
          # Run as non-root user
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 1000
          # Read-only root filesystem for immutability
          readOnlyRootFilesystem: true
          # Prevent privilege escalation
          allowPrivilegeEscalation: false
          # Drop all capabilities and add only required ones
          capabilities:
            drop:
              - ALL
            # Add specific capabilities if needed
            # add:
            #   - NET_BIND_SERVICE

        # Volume mounts for writable directories
        volumeMounts:
        # Temporary directory for application runtime files
        - name: tmp
          mountPath: /tmp
        # Cache directory for application-specific cache
        - name: cache
          mountPath: /app/cache

      # Volumes for writable directories
      # Using emptyDir since we have read-only root filesystem
      volumes:
      - name: tmp
        emptyDir:
          # Limit tmp directory size to prevent disk exhaustion
          sizeLimit: 100Mi
      - name: cache
        emptyDir:
          sizeLimit: 200Mi
